From cf515a8433bd9dd301169bf0b9d2774a8bf14225 Mon Sep 17 00:00:00 2001
From: Thomas Staudinger <Staudi.Kaos@gmail.com>
Date: Mon, 21 Feb 2022 23:36:49 +0100
Subject: [PATCH] Replace youtube-dl with yt-dlp

---
 lollypop/application.py        |  4 ++--
 lollypop/helper_web_youtube.py | 10 +++++-----
 lollypop/menu_similars.py      |  4 ++--
 lollypop/utils_file.py         | 16 ++++++++--------
 lollypop/view_albums_box.py    |  8 ++++----
 5 files changed, 21 insertions(+), 21 deletions(-)

diff --git a/lollypop/application.py b/lollypop/application.py
index 0c7636cc7..0e74a2baa 100644
--- a/lollypop/application.py
+++ b/lollypop/application.py
@@ -28,7 +28,7 @@ from signal import signal, SIGINT, SIGTERM
 from lollypop.utils import init_proxy_from_gnome
 from lollypop.application_actions import ApplicationActions
 from lollypop.application_cmdline import ApplicationCmdline
-from lollypop.utils_file import install_youtube_dl
+from lollypop.utils_file import install_yt_dlp
 from lollypop.define import LOLLYPOP_DATA_PATH, StorageType
 from lollypop.database import Database
 from lollypop.player import Player
@@ -174,7 +174,7 @@ class Application(Gtk.Application, ApplicationActions, ApplicationCmdline):
         if monitor.get_network_available() and\
                 not monitor.get_network_metered() and\
                 self.settings.get_value("recent-youtube-dl"):
-            self.task_helper.run(install_youtube_dl)
+            self.task_helper.run(install_yt_dlp)
 
     def do_startup(self):
         """
diff --git a/lollypop/helper_web_youtube.py b/lollypop/helper_web_youtube.py
index 0f6f4a36f..ad8cad6d8 100644
--- a/lollypop/helper_web_youtube.py
+++ b/lollypop/helper_web_youtube.py
@@ -16,7 +16,7 @@ from re import sub
 
 from lollypop.helper_web_base import BaseWebHelper
 from lollypop.utils import emit_signal
-from lollypop.utils_file import get_youtube_dl
+from lollypop.utils_file import get_yt_dlp
 from lollypop.logger import Logger
 
 
@@ -45,7 +45,7 @@ class YouTubeWebHelper(BaseWebHelper):
             proxy = GLib.environ_getenv(GLib.get_environ(), "all_proxy")
             if proxy is not None and proxy.startswith("socks://"):
                 proxy = proxy.replace("socks://", "socks4://")
-            (path, env) = get_youtube_dl()
+            (path, env) = get_yt_dlp()
             # Remove playlist args
             uri = sub("list=.*", "", uri)
             argv = [path, "--no-cache-dir", "-g", "-f", "bestaudio", uri]
@@ -54,14 +54,14 @@ class YouTubeWebHelper(BaseWebHelper):
             else:
                 argv.append(None)
             process = Gio.Subprocess.new(argv, Gio.SubprocessFlags.STDOUT_PIPE)
-            process.wait_async(cancellable, self.__on_youtube_dl, cancellable)
+            process.wait_async(cancellable, self.__on_yt_dlp, cancellable)
         except Exception as e:
             Logger.error("YouTubeWebHelper::get_uri_content(): %s", e)
 
 #######################
 # PRIVATE             #
 #######################
-    def __on_youtube_dl(self, process, result, cancellable):
+    def __on_yt_dlp(self, process, result, cancellable):
         """
             Emit signal for content
             @param process as Gio.Subprocess.
@@ -81,5 +81,5 @@ class YouTubeWebHelper(BaseWebHelper):
                 stream.close()
                 content = bytes.decode("utf-8")
         except Exception as e:
-            Logger.warning("YouTubeWebHelper::__on_youtube_dl(): %s", e)
+            Logger.warning("YouTubeWebHelper::__on_yt_dlp(): %s", e)
         emit_signal(self, "uri-content-loaded", content)
diff --git a/lollypop/menu_similars.py b/lollypop/menu_similars.py
index 067a633a6..16a06bedb 100644
--- a/lollypop/menu_similars.py
+++ b/lollypop/menu_similars.py
@@ -16,7 +16,7 @@ from gettext import gettext as _
 
 from lollypop.define import App, ArtSize, ArtBehaviour, Type, StorageType
 from lollypop.utils import sql_escape
-from lollypop.utils_file import get_youtube_dl
+from lollypop.utils_file import get_yt_dlp
 from lollypop.helper_signals import SignalsHelper, signals_map
 
 
@@ -126,7 +126,7 @@ class SimilarsMenu(Gtk.Bin, SignalsHelper):
             @param artist_id as int
         """
         Gtk.Bin.__init__(self)
-        (path, env) = get_youtube_dl()
+        (path, env) = get_yt_dlp()
         self.__show_all = path is not None
         self.__added = []
         self.__artist_id = artist_id
diff --git a/lollypop/utils_file.py b/lollypop/utils_file.py
index f928d5948..042c62354 100644
--- a/lollypop/utils_file.py
+++ b/lollypop/utils_file.py
@@ -152,29 +152,29 @@ def create_dir(path):
             Logger.info("Can't create %s" % path)
 
 
-def install_youtube_dl():
+def install_yt_dlp():
     try:
         path = GLib.get_user_data_dir() + "/lollypop/python"
-        argv = ["pip3", "install", "-t", path, "-U", "youtube-dl"]
+        argv = ["pip3", "install", "-t", path, "-U", "yt-dlp"]
         GLib.spawn_sync(None, argv, [], GLib.SpawnFlags.SEARCH_PATH, None)
     except Exception as e:
-        Logger.error("install_youtube_dl: %s" % e)
+        Logger.error("install_yt_dlp: %s" % e)
 
 
-def get_youtube_dl():
+def get_yt_dlp():
     """
-        Get youtube-dl path and env
+        Get yt-dlp path and env
         @return (str, [])
     """
     if App().settings.get_value("recent-youtube-dl"):
         python_path = GLib.get_user_data_dir() + "/lollypop/python"
-        path = "%s/bin/youtube-dl" % python_path
+        path = "%s/bin/yt-dlp" % python_path
         env = ["PYTHONPATH=%s" % python_path]
         f = Gio.File.new_for_path(path)
         if f.query_exists():
             return (path, env)
-    if GLib.find_program_in_path("youtube-dl"):
-        return ("youtube-dl", [])
+    if GLib.find_program_in_path("yt-dlp"):
+        return ("yt-dlp", [])
     else:
         return (None, [])
 
diff --git a/lollypop/view_albums_box.py b/lollypop/view_albums_box.py
index 6ff890d3e..39b1a2aa7 100644
--- a/lollypop/view_albums_box.py
+++ b/lollypop/view_albums_box.py
@@ -23,7 +23,7 @@ from lollypop.objects_album import Album
 from lollypop.utils import get_icon_name, get_network_available, popup_widget
 from lollypop.utils import get_title_for_genres_artists
 from lollypop.utils import remove_static
-from lollypop.utils_file import get_youtube_dl
+from lollypop.utils_file import get_yt_dlp
 from lollypop.utils_album import get_album_ids_for
 from lollypop.helper_signals import SignalsHelper, signals_map
 
@@ -50,9 +50,9 @@ class AlbumsBoxView(FlowBoxView, SignalsHelper):
         self.__populate_wanted = True
         if genre_ids and genre_ids[0] < 0:
             if genre_ids[0] == Type.WEB:
-                (youtube_dl, env) = get_youtube_dl()
-                if youtube_dl is None:
-                    self._empty_message = _("Missing youtube-dl command")
+                (yt_dlp, env) = get_yt_dlp()
+                if yt_dlp is None:
+                    self._empty_message = _("Missing yt-dlp command")
                     self.show_placeholder(True)
                     self.__populate_wanted = False
                 elif not get_network_available("YOUTUBE"):
-- 
2.35.1

